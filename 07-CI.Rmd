```{r, include = FALSE}
knitr::opts_chunk$set(error = FALSE, warning = FALSE, message = FALSE, out.width  = '100%', fig.width  = 8, fig.height = 5, fig.align  = 'center')

library(ggplot2)

```

# Confidence Intervals{#confint}

When we report point estimates, we should acknowledge and quantify the uncertainty in these estimates. Confidence intervals provide a way to quantify the precision of an estimate. By reporting an estimate with a confidence interval, results are reported within a range of value that contain the true value of the parameter with a desired percentage. For example, when we report an effect size estimate with a 95% confidence interval, the expectation is that the interval is wide enough such that 95% of the time the range of values around the estimate contains the true parameter value.

## Population vs. Sample

In statistics, we differentiate between the population and the sample. The population is everyone you are interested in, such as all people in the world, elderly who are depressed, or people who buy innovative products. Your sample is everyone you were able to measure from the population you are interested in. We similarly distinguish between a parameter and a statistic. A parameter is a characteristic of the population, while a statistic is a characteristic of a sample. Sometimes, you have data about your entire population. For example, we have measured the height of all the people who have ever walked on the moon. We can calculate the average height of these twelve individuals, and so we know the true parameter. We do not need inferential statistics. However, we do not know the average height of all people who have ever walked on the earth. Therefore, we need to estimate this parameter, using a statistic based on a sample. Although it is rare that a study includes the entire population, it is not impossible, as illustrated in Figure \@ref(fig:population). 

```{r, population, fig.margin = FALSE, echo = FALSE, fig.cap="Example of a registry-based study in which the entire population was included in the study. From https://doi.org/10.1093/ije/dyab066"}
knitr::include_graphics("images/population.png")
```

When the entire population is measured there is no need to perform a hypothesis test. After all, there is no population to generalize to (although it is possible to argue we are still making an inference, even when the entire population is observed, because we have observed a *metaphorical population* from one of many possible worlds, see @spiegelhalter_art_2019). When data from the entire population has been collected the population effect size is known, and there is no confidence interval to compute. If the total population size is known, but not measured completely, then the confidence interval width should shrink to zero the closer a study gets to measuring the entire population. This is known as the finite population correction factor for the variance of the estimator [@kish_survey_1965]. The variance of a sample mean is $\sigma^2/n$, which for finite populations is multiplied by the finite population correction factor of the standard error:
$$FPC = \sqrt{\frac{(N - n)}{(N-1)}}$$
where *N* is the size of the population, and *n* is the size of the sample. When *N* is much larger than *n*, the correction factor will be close to 1 (and therefore this correction is typically ignored when populations are very large, even when populations are finite), and will not have a noticeable effect on the variance. When the total population is measured the correction factor is 0, such that the variance becomes 0 as well. For example, when the total population consists of 100 top athletes, and data is collected from a sample of 35 athletes, the finite population correction is $\sqrt{(100 - 35)/(100-1)}$ = `r round(sqrt((100 - 35)/(100-1)),2)`. The `superb` R package can compute population corrected confidence intervals [@cousineau_superb_2019]. 

## What is a Confidence Interval?

Confidence intervals are a statement about the percentage of confidence intervals that contain the true parameter value. This behavior of confidence intervals is nicely visualized on this website by Kristoffer Magnusson: <http://rpsychologist.com/d3/CI/>.  In Figure \@ref(fig:cisim) We see blue dots that represent means from a sample, and that fall around a red vertical line, which represents the true value of the parameter in the population. Due to variation in the sample, the estimates do not all fall on the red line. The horizontal lines around the blue dots are the confidence intervals. By default, the visualization shows 95% confidence intervals. Most of the lines are black (which means the confidence interval overlaps with the red line indication the true population value), but some are red (indicating they do not capture the true population value). In the long run, 95% of the horizontal bars will be black, and 5% will be red. 

```{r, cisim, fig.margin = FALSE, echo = FALSE, fig.cap="Series of simulated point estimates and confidence intervals"}
knitr::include_graphics("images/cisim.png")
```

We can now see what is meant by the sentence “Confidence intervals are a statement about the percentage of confidence intervals that contain the true parameter value“. In the long run, for 95% of the samples, the red line (the population parameter) is contained within the 95% confidence interval around the sample mean, and in 5% of the confidence intervals this is not true. As we will see when we turn to the formula for confidence intervals, the width of a confidence interval depends on the sample size and the standard deviation. The larger the sample size, the smaller the confidence intervals. Cohen [-@] reflected on the reason confidence intervals were rarely reporting in 1994: "I suspect that the main reason they are not reported is that they are so embarrassingly large!" This might be, but another reason might have been that statistical software rarely provided confidence intervals around effect sizes in the time when Cohen wrote his article. With the increasing availability of free software packages, for example in R, it has become much easier to compute confidence intervals. The [Journal Article Reporting Standards](https://apastyle.apa.org/jars/quantitative) now recommend to report "effect-size estimates and confidence intervals on estimates that correspond to each inferential test conducted, when possible".

## The relation between confidence intervals and *p*-values {#relatCIp}

There is a direct relationship between the CI around an effect size and statistical significance of a null-hypothesis significance test. For example, if an effect is statistically significant (*p* \< 0.05) in a two-sided independent *t*-test with an alpha of .05, the 95% CI for the mean difference between the two groups will not include zero. Confidence intervals are sometimes said to be more informative than *p*-values, because they do not only provide information about whether an effect is statistically significant (i.e., when the confidence interval does not overlap with the value representing the null hypothesis), but also communicate the precision of the effect size estimate. This is true, but as mentioned in the chapter on [*p*-values](pvalue) it is still recommended to add exact *p*-values, which facilitates the re-use of results for secondary analyses [@appelbaum_journal_2018], and allows other researchers to compare the *p*-value to an alpha level they would have preferred to use [@lehmann_testing_2005].

In order to maintain the direct relationship between a confidence interval and a *p*-value it is necessary to adjust the confidence interval level whenever the alpha level is adjusted. For example, if an alpha level of 5% is corrected for three comparisons to 0.05/3 - 0.0167, the corresponding confidence interval would be a 1 - 0.0167 = 0.9833 confidence interval. Similarly, if a *p*-value is computed for a one-sided test, there is only an upper or lower limit of the interval, and the other end of the interval ranges to −∞ or ∞. 

Confidence intervals are often used in forest plots that communicate the results from a meta-analysis. In the plot below, we see 4 rows. Each row shows the effect size estimate from one study (in Hedges’ g). For example, study 1 yielded an effect size estimate of 0.44, with a confidence interval around the effect size from 0.08 to 0.8. The horizontal black line, similarly to the visualization we played around with before, is the width of the confidence interval. When it does not touch the effect size 0 (indicated by a black vertical line) the effect is statistically significant.


```{r, meta, echo=FALSE, fig.cap="Meta-analysis of 4 studies"}
set.seed(2238)

nSims <- 4 # number of simulated studies

pop.m1 <- 106
pop.sd1 <- 15
pop.m2 <- 100
pop.sd2 <- 15
metadata <- data.frame(yi = numeric(0), vi = numeric(0))

for (i in 1:nSims) { # for each simulated study
  n <- sample(30:80, 1)
  x <- rnorm(n = n, mean = pop.m1, sd = pop.sd1) # produce  simulated participants
  y <- rnorm(n = n, mean = pop.m2, sd = pop.sd2) # produce  simulated participants
  metadata[i,1] <- metafor::escalc(n1i = n, n2i = n, m1i = mean(x), m2i = mean(y), sd1i = sd(x), sd2i = sd(y), measure = "SMD")$yi
  metadata[i,2] <- metafor::escalc(n1i = n, n2i = n, m1i = mean(x), m2i = mean(y), sd1i = sd(x), sd2i = sd(y), measure = "SMD")$vi
}

result <- metafor::rma(yi, vi, data = metadata, method = "FE")
par(mar=c(4,0,4,0))
metafor::forest(result)
title("Forest plot for a simulated meta-analysis")

```

We can see, based on the fact that the confidence intervals do not overlap with 0, that studies 1 and 3 were statistically significant. The diamond shape next the FE model (Fixed Effect model) is the meta-analytic effect size. Instead of using a black horizontal line, the upper limit and lower limit of the confidence interval are indicated by the left and right points of the diamond, and the center of the diamond is the meta-analytic effect size estimate. A meta-analysis calculates the effect size by combining and weighing all studies. The confidence interval for a meta-analytic effect size estimate is always narrower than that for a single study, because of the combined sample size of all studies included in the meta-analysis.

## The Standard Error and 95% Confidence Intervals

To calculate a confidence interval, we need the standard error. The standard error (SE) estimates the variability between sample means that would be obtained after taking several measurements from the same population. It is easy to confuse it with the standard deviation, which is the degree to which individuals within the sample differ from the sample mean. Formally, statisticians distinguish between σ and $\widehat{\sigma}$, where the hat means the value is estimated from a sample, and the lack of a hat means it is the population value – but I’ll leave out the hat, even when I’ll mostly talk about estimated values based on a sample in the formulas below. Mathematically (where σ is the standard
deviation),

$$
Standard \ Error \ (SE) = \sigma/\sqrt n
$$

The standard error of the sample will tend to zero with increasing sample size, because the estimate of the population mean will become more and more accurate. The standard deviation of the sample will become more and more similar to the population standard deviation as the sample size increases, but it will not become smaller. Where the standard deviation is a statistic that is descriptive of your sample, the standard error describes bounds on a random sampling process.

The Standard Error is used to construct confidence intervals (CI) around sample estimates, such as the mean, or differences between means, or whatever statistics you might be interested in. To calculate a confidence interval around a mean (indicated by the Greek letter mu: μ), we use the *t* distribution with the corresponding degrees of freedom (*df* : in a one-sample *t*-test, the degrees of freedom are n-1):

$$
\mu \pm t_{df, 1-(\alpha/2)} SE
$$


With a 95% confidence interval, the α = 0.05, and thus the critical *t*-value for the degrees of freedom for 1- α /2, or the 0.975th quantile is calculated. Remember that a *t*-distribution has slightly thicker tails than a Z-distribution. Where the 0.975th quantile for a Z-distribution is 1.96, the value for a *t*-distribution with for example df = 19 is 2.093. This value is multiplied by the standard error, and added (for the upper limit of the confidence interval) or subtracted (for the lower limit of the confidence
interval) from the mean.

## Overlapping Confidence Intervals

Confidence intervals are often used in plots. In Figure \@ref(fig:cioverlap) below, three estimates are vizluaized (the dots), surrounded by three lines (the 95% confidence intervals). The left two dots (X and Y) represent the *means* of the independent groups X and Y on a scale from 0 to 8 (see the axis from 0-8 on the left side of the plot). The dotted lines between the two confidence intervals visualize the overlap between the confidence intervals around the means. The two confidence intervals around means in columns X and Y are commonly shown in a figure in a scientific article. The third dot, slightly larger, is the *mean difference* between X and Y, and slightly thicker line visualizes the confidence interval of this mean difference. The difference score is expressed using the axis on the right (from -3 to 5). In the plot below, the mean of group X is 3, the mean of group Y is 5.6, and the difference is 2.6. The plot is based on 50 observations per group, and the confidence interval around the mean difference ranges from 0.49 to 4.68, which is quite wide. 

```{r, cioverlap, echo=FALSE, fig.cap="Means and 95% confidence intervals of two independent groups and the mean difference and it's 95% confidence interval."}

set.seed(629)

x <- rnorm(n = 50, mean = 3, sd = 5) # get sample group 1
y <- rnorm(n = 50, mean = 5, sd = 5) # get sample group 2

d <- data.frame(
  labels = c("X", "Y", "Difference"),
  mean = c(mean(x), mean(y), mean(y) - mean(x)),
  lower = c(t.test(x)[[4]][1], t.test(y)[[4]][1], t.test(y, x)[[4]][1]),
  upper = c(t.test(x)[[4]][2], t.test(y)[[4]][2], t.test(y, x)[[4]][2])
)

plot(NA, xlim = c(.5, 3.5), ylim = c(0, max(d$upper[1:2] + 1)), bty = "l", 
     xaxt = "n", xlab = "", ylab = "Mean")
points(d$mean[1:2], pch = 19)
segments(1, d$mean[1], 5, d$mean[1], lty = 2)
segments(2, d$mean[2], 5, d$mean[2], lty = 2)
axis(1, 1:3, d$labels)
segments(1:2, d$lower[1:2], 1:2, d$upper[1:2])
axis(4, seq((d$mean[1] - 3), (d$mean[1] + 5), by = 1), seq(-3, 5, by = 1))
points(3, d$mean[1] + d$mean[3], pch = 19, cex = 1.5)
segments(3, d$mean[1] + d$lower[3], 3, d$mean[1] + d$upper[3], lwd = 2)
mtext("Difference", side = 4, at = d$mean[1], line = 3)
segments(1:1, d$upper[1:1], 1:2, d$upper[1:1], lty = 3)
segments(1:1, d$lower[1:2], 1:2, d$lower[1:2], lty = 3)
text(3, 1, paste("P-value", round(t.test(x, y)$p.value, digits = 3)))

```

As mentioned earlier, when a 95% confidence interval does not contain 0, the effect is statistically different from 0. In Figure \@ref(fig:cioverlap) above the mean difference and the 95% confidence interval around it are indicaed by the 'difference' label. As the 95% confidence interval does not contain 0, the *t*-test is significant at an alpha of 0.05. The *p*-value is indicated in the plot as 0.016. Even though the two means differ statistically from each other, the confidence interval around each mean overlap. One might intuitively believe that an effect is only statistically significant if the confidence interval around the individual means do not overlap, but this is not true. The significance test is related to the confidence interval around the mean difference. 

## Prediction Intervals

Even though 95% of future confidence intervals will contain the true parameter, a 95% confidence interval will not contain 95% of future individual observations. Sometimes, researchers want to predict the interval within which a single value will fall. This is called the prediction interval. It is always much wider than a confidence interval. The reason is that individual observations can vary substantially, but means of future samples (which fall within a normal confidence interval 95% of the time) will vary much less.

In Figure \@ref(fig:predictioninterval) the orange background illustrates the 95% confidence interval around the mean, and the lighter yellow background illustrates the 95% prediction interval (PI). 

```{r, predictioninterval, echo=TRUE, fig.cap="A comparison of a 95% confidence interval (gold) and 95% prediction interval (yellow)."}

set.seed(1009)
n <- 20 # set sample size
nsims <- 100000 # set number of simulations

x <- rnorm(n = n, mean = 100, sd = 15) # create sample from normal distribution

# 95% Confidence Interval
ciu <- mean(x) + qt(0.975, df = n - 1) * sd(x) * sqrt(1 / n)
cil <- mean(x) - qt(0.975, df = n - 1) * sd(x) * sqrt(1 / n)

# 95% Prediction Interval
piu <- mean(x) + qt(0.975, df = n - 1) * sd(x) * sqrt(1 + 1 / n)
pil <- mean(x) - qt(0.975, df = n - 1) * sd(x) * sqrt(1 + 1 / n)

ggplot(as.data.frame(x), aes(x)) + # plot data
  geom_rect(aes(xmin = pil, xmax = piu, ymin = 0, ymax = Inf),
            fill = "gold") + # draw yellow PI area
  geom_rect(aes(xmin = cil, xmax = ciu, ymin = 0, ymax = Inf),
            fill = "#E69F00") + # draw orange CI area
  geom_histogram(colour = "black", fill = "grey", aes(y = ..density..),
                 bins = 20) +  xlab("Score") +  ylab("frequency") +
  theme_bw(base_size = 20) +
  theme(panel.grid.major.x = element_blank(), axis.text.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  geom_vline(xintercept = mean(x), linetype = "dashed", size = 1) +
  coord_cartesian(xlim = c(50, 150)) +
  scale_x_continuous(breaks = c(seq(50, 150, 10))) +
  annotate("text", x = mean(x), y = 0.02, label = paste(
    "Mean = ", round(mean(x)), "\n",
    "SD = ", round(sd(x)), sep = ""), size = 6.5)


```

To calculate the prediction interval, we need a slightly different formula for the standard error, that was used for the confidence interval, namely:

$$
Standard \ Error \ (SE) = \sigma/\sqrt(1+1/n)
$$

When we rewrite the formula used for the confidence interval to $$\sigma/\sqrt(1/N)$$, we see the difference between a confidence interval and the prediction interval is in the “1+” which always leads to wider intervals. Prediction intervals are **wider**, because they are constructed so that they will contain **a single future value** 95% of the time, instead of the **mean**. The fact that prediction intervals are wide is a good reminder that it is difficult te predict what will happen for any single individual.

## Capture Percentages

It can be difficult to understand why a 95% confidence interval does not provide us with the interval where 95% of future means will fall. The percentage of means that falls within a single confidence interval is called the **capture percentage**. A 95% confidence interval is only a 95% capture percentage when the statistic (such as an effect size) you observe in a single sample happens to be exactly the same as the true parameter. This situation is illustrated in the picture below. The observed effect size (dot) falls exactly on the true effect size (vertical dotted line). In this case, and *only in this case*, 95% of future means will fall within this 95% confidence interval.

![](images/capture1.jpg)

However, you can’t know whether your observed effect size happens to be exactly the same as the population effect size. When this is not the case (and it is almost never exactly the case) less than 95% of future effect sizes will fall within the CI from your current sample. The right side of the figure illustrates this. Let’s assume we observed an effect size much lower to the true effect size. We know that effect sizes from the sample are randomly distributed around the true effect size. Very often, we should find effect size estimates in our sample that fall outside the 95% confidence interval of the single sample we happen to have observed. So, the percentage of future means that fall within a single confidence interval depends upon which single confidence interval you happened to observe! In the long run, a 95% CI has an 83.4% capture probability [@cumming_confidence_2006].

Let’s experience this through simulation. The simulation in the R script generates a large number of additional samples, after the initial one that was plotted. The simulation returns the number of CI that contains the mean (which should be 95% in the long run). The simulation also returns the % of means from future studies that fall within the 95% of the original study, or the capture percentage. It differs from (and is often lower, but sometimes higher, than) the confidence interval.

Q8: Run the simulations multiple times. Look at the output you will get in the R
console. For example: “95.077 % of the 95% confidence intervals contained the
true mean” and “The capture percentage for the plotted study, or the % of values
within the observed confidence interval from 88.17208 to 103.1506 is: 82.377 %”.
While running the simulations multiple times, look at the confidence interval
around the sample mean, and relate this to the capture percentage. Which
statement is true?

A) The farther the sample mean is from the true population mean, the lower the
capture percentage.

B) The farther the sample mean is from the true population mean, the higher the
capture percentage.

Q9: Simulations in R are randomly generated, but you can make a specific
simulation reproducible by setting the seed of the random generation process.
Copy-paste “set.seed(1000)” to the first line of the R script, and run the
simulation. The sample mean should be 94. What is the capture percentage? (Don’t
forget to remove the set.seed command if you want to generate more random
simulations!).

A) 95%

B) 42.1%

C) 84.3%

D) 89.2%

Capture percentages are rarely directly used to make statistical inferences. The
main reason we discuss them here is really to prevent the common
misunderstanding that 95% of future means fall within a single confidence
interval: Capture percentages clearly show that is not true. Prediction
intervals are also rarely used in psychology, but are more common in data
science.

In this assignment you have learned why it is important to provide a measure of the uncertainty of your estimates. We have discussed the correct interpretation of confidence intervals, the meaning of prediction intervals, and the difference between a confidence interval and a capture percentage. 
## Using CI for equivalence tests

```{r}
n = 100 #set sample size
x<-rnorm(n = n, mean = 100, sd = 15) #create sample from normal distribution
y<-rnorm(n = n, mean = 106, sd = 15) #create sample from normal distribution

effectsize::cohens_d(x, y)

# Immediate equivalence test
effectsize::equivalence_test(
  effectsize::cohens_d(x, y),
  range = "default",
  rule = c("classic"),
)

```

## Computing Confidence Intervals around Effect Sizes

### MOTE 

Currently the easiest and most complete solution to calculating effect sizes and confidence intervals is [MOTE](https://www.aggieerin.com/shiny-server/) made by Dr. Erin Buchanan and her lab. The website comes with a full collections of tutorials, comparisons with other software packages, and demonstration videos giving incredible accessible overviews of how to compute effect sizes for a wide range of tests. For example, the video below gives an overview for an independent *t*-test

<iframe width="560" height="315" src="https://www.youtube.com/embed/kH3UOoFh9Ng?start=9" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

MOTE is also available as an R package [@buchanan_mote_2017]. It contains many useful functions, such as ways to compute effect sizes from summary statistics, which provide output that can conveniently be embedded in an R Markdown document:

```{r MOTE}
library(MOTE)

res <- d.ind.t(m1 = 1.7, m2 = 2.1, sd1 = 1.01, sd2 = 0.96, n1 = 77, n2 = 78, a = .05)
res$statistic
res$estimate
```

Although many solutions exists to compute Cohen's d, MOTE sets itself apart by allowing researchers to compute effect sizes and confidence intervals for many additional effect sizes, such as (partial) omega squared for between subjects ANOVA ($\omega^{2}$ and $\omega^{2}_p$), generalized omega squared for ANOVA ($\omega^{2}_G$), Epsilon squared for ANOVA ($\varepsilon^{2}$) and (partial) generalized eta squared for ANOVA ($\eta^{2}_G$), as well as Hedges' g (bias corrected Cohen's d). If you are want to compute effect sizes and their confidence intervals, this is the first resource you should try. 

### JASP

Free statistical software [JAPS](https://jasp-stats.org/) is a strong alternative to SPSS that (unlike SPSS) allows users to compute Cohen's d and the confidence interval for both independent and dependent *t*tests.

```{r jasp1, fig.margin = FALSE, echo = FALSE, fig.cap="JASP menu option allows you to select Cohen's d and a CI around it."}
knitr::include_graphics("images/jaspeffectci1.png")
```

```{r jasp2, fig.margin = FALSE, echo = FALSE, fig.cap="JASP output returns Cohen's d and the confidence interval around it."}
knitr::include_graphics("images/jaspeffectci2.png")
```

JASP also allows you to compute omega squared $\omega^{2}$, the less biased version of $\varepsilon^{2}$ and 


### ESCI software

For people who prefer to use [ESCI software](https://thenewstatistics.com/itns/esci/) by Geoff Cumming, ESCI also has an option to provide 95% CI around Cohen's d, both for independent as for dependent *t*-tests. However, the option is slightly hidden - you need to scroll to the right, where you can check a box which is placed out of view.

```{r esci, fig.margin = FALSE, echo=FALSE, fig.cap="ESCI software has a somewhat hidden option to compute 95% CI around Cohen's d for within and between *t*-tests."}
knitr::include_graphics("images/esci1.png")
```

### MBESS

MBESS is another R package that has a range of options to compute effect sizes and their confidence intervals [@kelley_confidence_2007]. The code below reproduces the example for MOTE above.

```{r}
library(MBESS)

# Cohen's d
smd(Mean.1 = 1.7, 
    Mean.2 = 2.1, 
    s.1 = 1.01, 
    s.2 = 0.96, 
    n.1 = 77, 
    n.2 = 78)

# Hedges' g
smd(Mean.1 = 1.7, 
    Mean.2 = 2.1, 
    s.1 = 1.01, 
    s.2 = 0.96, 
    n.1 = 77, 
    n.2 = 78, 
    Unbiased = TRUE)

```

To get the confidence interval for the proportion of variance (r², or η², or partial η²) in a fixed factor analysis of variance we need the ci.pvaf function. We need to specify the F-value, degrees of freedom,  the sample size, and the confidence level.

```{r}
ci.pvaf(F.value=5.72, df.1=1, df.2=198, N=200, conf.level=.90)
```

For within designs, the MBESS package returns an error. For example:

```{r cipvaf, error = TRUE}
ci.pvaf(F.value = 25.73, df.1 = 2, df.2 = 28, N = 18, conf.level = 0.9)
```

This error is correct in between-subjects designs (where the sample size is larger than the degrees of freedom) but this is not true in within-designs (where the sample size is smaller than the degrees of freedom for many of the tests). Thankfully, Ken Kelley (who made the MBESS package) helped me out in an e-mail by pointing out you could just use the R Code within the ci.pvaf function and adapt it. Just change the F-value, confidence level, and the df.1 and df.2.

```{r customcode}
Lims <- conf.limits.ncf(F.value = 7, conf.level = 0.90, df.1 <- 4, df.2 <- 50)
Lower.lim <- Lims$Lower.Limit/(Lims$Lower.Limit + df.1 + df.2 + 1)
Upper.lim <- Lims$Upper.Limit/(Lims$Upper.Limit + df.1 + df.2 + 1)
Lower.lim
Upper.lim
```

### Why should you report 90% CI for eta-squared?

You will see that in the code above I used a 90% CI for effect sizes calculated for an *F*-test. The reason for this is explained by [Karl Wuensch](http://core.ecu.edu/psyc/wuenschk/StatHelp/StatHelp.htm), a leader in the field of applied statistics education, who has gone out of his way to explain this in a very clear document, including examples, [which you can find here](http://core.ecu.edu/psyc/wuenschk/docs30/CI-Eta2-Alpha.doc). If you don’t want to read it, you should know that while Cohen’s d can be both positive and negative, r² or η² are squared, and can therefore only be positive. This is related to the fact that *F*-tests (as commonly used in ANOVA) are one-sided. If you calculate a 95% CI, you can get situations where the confidence interval includes 0, but the test reveals a statistical difference with a *p* < .05 (for a more mathematical explanation, see @steiger_beyond_2004. This means that a 95% CI around Cohen's d equals a 90% CI around η² for exactly the same test. 

As a final detail, because eta-squared cannot be smaller than zero, the lower bound for the confidence interval can not be smaller than 0. This means that a confidence interval for an effect that is not statistically different from 0 has to start at 0. You report such a CI as 90% CI [.00; .XX]  where the XX is the upper limit of the CI. 


## Calculating Confidence Intervals around Standard Deviations.

If we calculate a standard deviation (SD) from a sample, this value is an
estimate of the true value in the population. In small samples, our estimate can
be quite far off. But due to the law of large numbers, as our sample size
increases, we will be measuring the standard deviation more accurately. Since
the sample standard deviation is an estimate with uncertainty, we can calculate
a 95% confidence interval around it.

Expressing the uncertainty in our estimate of the standard deviation can be
useful. When researchers plan to simulate data, or perform an a-priori power
analysis, they need accurate estimates of the standard deviation. For
simulations, the standard deviation needs to be accurate because we want to
generate data that will look like the real data we will eventually collect. For
power analyses, we often want to think about the smallest effect size of
interest (SESOI), which can be specified as the difference in means which you
care about. To perform a power analysis, we also need to specify the expected
standard deviation of the data. Sometimes researchers will use pilot data to get
an estimate of the standard deviation. Since the estimate of the population
standard deviation based on a pilot study has some uncertainty, confidence
intervals might be a useful way to quantify the amount of uncertainty.

**Open the R code Confidence_Intervals_for_Standard_Deviations.R** to calculate
the confidence interval around a standard deviation from a sample. You can also
use [this free GraphPad
calculator](https://www.graphpad.com/quickcalcs/CISD1.cfm) to calculate
confidence intervals for standard deviations. Run lines 1 to 3 to load the pwr
package. Lines 5 to 8 specify the alpha level (and thus the 1-α confidence
interval), the number of observations (n), the population standard deviations
(st_dev), and the smallest effect size a researcher is interested in (SESOI).
The code calculates the critical values for the upper and lower confidence
interval (lines 11 and 12), and then calculates the confidence interval for the
standard deviation (lines 15 and 16).


```{r}
#Install pwr package if needed
if (!require(pwr)) {install.packages('pwr')}
library(pwr)

alpha_level <- 0.05 #set alpha level
n <- 100 #set number of observations
st_dev <- 1 #set true standard deviation
SESOI <- 0.5 #set smallest effect size of interest (raw mean difference)

# calculate lower and upper critical values c_l and c_u
c_l <- sqrt((n - 1)/qchisq(alpha_level/2, n - 1, lower.tail = FALSE))
c_u <- sqrt((n - 1)/qchisq(alpha_level/2, n - 1, lower.tail = TRUE))

# calculate lower and upper confidence interval for sd
st_dev * c_l
st_dev * c_u

# d based on lower bound of the 95CI around the SD
SESOI/(st_dev * c_l)
# d based on upper bound of the 95CI around the SD
SESOI/(st_dev * c_u)

pwr.t.test(d = SESOI/(st_dev * c_l), power = 0.9, sig.level = 0.05)
pwr.t.test(d = SESOI/(st_dev * c_u), power = 0.9, sig.level = 0.05)

# Power analysis for true standard deviation for comparison
pwr.t.test(d = SESOI/st_dev, power = 0.9, sig.level = 0.05)

```

**Q1**: If you run lines 5 to 16 you will see that with an alpha level of 0.05,
100 observations, and a true standard deviation of 1, the 95% CI is [0.88;
1.16]. **Change the assumed population standard deviation from 1 to 2** in line
7. Keep all other settings the same. What is the 95% CI around the standard
deviation of 2 with 100 observations (run lines 5 to 16)?

A) 95% CI [1.38; 3.65]

B) 95% CI [1.76; 2.32]

C) 95% CI [1.82; 2.22]

D) 95% CI [1.84; 2.20]

**Q2**: **Change the assumed population standard deviation back from 2 to 1** in
line 7. **Lower the sample size from 100 to 20** in line 6. This will inform us
about the width of the confidence interval for a standard deviation when we run
a pilot study with 20 observations. Keep all other settings the same. What is
the 95% CI around the standard deviation of 1 with 20 observations (run lines 5
to 16)?

A) 95% CI [0.91; 1.11]

B) 95% CI [0.82; 1.28]

C) 95% CI [0.76; 1.46]

D) 95% CI [1.52; 2.92]

**Q3**: If we want the 95% CI around the standard deviation of 1 to be at most
0.05 away from the assumed population standard deviation, how large should our
number of observations be? Note that this means we want the 95% CI to fall
within 0.95 and 1.05. But notice from the calculations above that the
distribution of the sample standard deviations is not symmetrical. Standard
deviations can’t be smaller than 0 (because they are the square rooted
variance). So in practice the question is: What is the smallest number of
observations for the upper 95% CI to be smaller than 1.05? Replace n on line 6
with each of these values.

A) n = 489

B) n = 498

C) n = 849

D) n = 948

Let’s explore what the consequences of an inaccurate estimate of the population
standard deviation are on a-priori power analyses. Let’s imagine we want to
perform an a-priori power analysis for a smallest effect size of interest of
half a scale point (on a scale from 1-5) on a measure that has an (unknown) true
population standard deviation of 1.2.

**Q4**: **Change the number of observations in line 6 to 50**. **Change the
assumed population standard deviation in line 7 to 1.2**. Keep the SESOI in line
8 to 0.5. The 95% confidence interval for the standard deviation based on a
sample of 50 observation ranges from 1.002 to 1.495 (run lines 5 to 16 to
confirm). To perform an a-priori power analysis we need to calculate Cohen’s d,
which is the difference divided by the standard deviation. In our example, we
want to at least observe a difference of 0.5. What is Cohen’s d (SESOI/SD) for
the lower bound of the 95% confidence interval (where SD = 1.002) or the upper
bound (where SD = 1.495)? **You can perform these calculations by running lines
19 and 21**.

A) d = 0.33 and d = 0.50

B) d = 0.40 and d = 0.60

C) d = 0.43 and d = 0.57

D) d = 0.29 and d = 0.55

If we draw a sample of 50 observations we can happen to observe a value that,
due to random variation, is much smaller or much larger than the true population
value. We can examine the effect this has on the number of observations that we
think will be required when we perform an a-priori power analysis.

**Q5**: An a-priori power analysis is performed that uses the estimate of
Cohen’s d based on the lower 95% CI of the standard deviation. Which statement
is true?

A) Because the lower bound of the 95% CI is **smaller** than the true population
SD, Cohen’s d is **smaller**, and the a-priori power analysis will yield a
sample size that is **smaller** than the sample size we really need.

B) Because the lower bound of the 95% CI is **smaller** than the true population
SD, Cohen’s d is **larger**, and the a-priori power analysis will yield a sample
size that is **larger** than the sample size we really need.

C) Because the lower bound of the 95% CI is **smaller** than the true population
SD, Cohen’s d is **smaller**, and the a-priori power analysis will yield a
sample size that is **larger** than the sample size we really need.

D) Because the lower bound of the 95% CI is **smaller** than the true population
SD, Cohen’s d is **larger**, and the a-priori power analysis will yield a sample
size that is **smaller** than the sample size we really need.

**Q6**: Let’s check if our answer on the previous question was correct. We still
have an alpha level of 0.05, n = 50, a standard deviation of 1.2, and a SESOI of
0.5. Run lines 23 and 24. The first power analysis uses Cohen’s d based on the
lower bound of the 95% confidence interval. The second power analysis uses the
upper bound of the 95% confidence interval. (There is also a third power
analysis based on the (in real-life situations unknown) true standard deviation,
just for comparison, on line 27). Which statement is true?

A) The sample size per group is 68 when calculating the effect size based on the
lower bound on the 95% CI around the standard deviation, and 86 when using the
upper bound of the 95% CI around the standard deviation.

B) The sample size per group is 68 when calculating the effect size based on the
lower bound on the 95% CI around the standard deviation, and 123 when using the
upper bound of the 95% CI around the standard deviation.

C) The sample size per group is 86 when calculating the effect size based on the
lower bound on the 95% CI around the standard deviation, and 123 when using the
upper bound of the 95% CI around the standard deviation.

D) The sample size per group is 86 when calculating the effect size based on the
lower bound on the 95% CI around the standard deviation, and 189 when using the
upper bound of the 95% CI around the standard deviation.

It is clear sample sizes from a-priori power analyses depend strongly on an
accurate estimate of the standard deviation. Keep into account that **estimates
of the standard deviation have uncertainty**. Use **validated or existing
measures for which accurate estimates of the standard deviation in your
population of interest are available**, so that you can rely on a better
estimate of the standard deviation in power analyses.

Some people argue that **if you have such a limited understanding of the
measures you are using that you do not even know the standard deviation of the
measure in your population of interest, you are not ready to use that measure to
test a hypothesis.** Think back to the lecture on whether you really wanted to
test a hypothesis. If you are doing a power analysis but realize you have no
idea what the standard deviation is, maybe you first need to spend more time
validating the measures you are using.

When performing simulations or power analyses the same cautionary note can be
made for estimates of correlations between dependent variables. When you are
estimating these values from a sample, and want to perform simulations and/or
power analyses, be aware that all estimates have some uncertainty. Try to get
estimates which are as accurate as possible from pre-existing data. If possible,
be a bit more conservative in sample size calculations based on estimated
parameters, just to be sure.


## Test Yourself


Copy the code below into R and run the code. It will generate plots like the one in Figure \@ref(fig:cioverlap). Run the entire script as often as you want (notice the variability in the *p*-values due to the relatively low power in the test!), to answer the following question. The *p*-value in the plot will tell you if the difference is statistically significant, and what the *p*-value is.

```{r, evaluate=FALSE}
x <- rnorm(n = 50, mean = 3, sd = 5) # get sample group 1
y <- rnorm(n = 50, mean = 5, sd = 5) # get sample group 2

d <- data.frame(
  labels = c("X", "Y", "Difference"),
  mean = c(mean(x), mean(y), mean(y) - mean(x)),
  lower = c(t.test(x)[[4]][1], t.test(y)[[4]][1], t.test(y, x)[[4]][1]),
  upper = c(t.test(x)[[4]][2], t.test(y)[[4]][2], t.test(y, x)[[4]][2])
)

plot(NA, xlim = c(.5, 3.5), ylim = c(0, max(d$upper[1:2] + 1)), bty = "l", 
     xaxt = "n", xlab = "", ylab = "Mean")
points(d$mean[1:2], pch = 19)
segments(1, d$mean[1], 5, d$mean[1], lty = 2)
segments(2, d$mean[2], 5, d$mean[2], lty = 2)
axis(1, 1:3, d$labels)
segments(1:2, d$lower[1:2], 1:2, d$upper[1:2])
axis(4, seq((d$mean[1] - 3), (d$mean[1] + 5), by = 1), seq(-3, 5, by = 1))
points(3, d$mean[1] + d$mean[3], pch = 19, cex = 1.5)
segments(3, d$mean[1] + d$lower[3], 3, d$mean[1] + d$upper[3], lwd = 2)
mtext("Difference", side = 4, at = d$mean[1], line = 3)
segments(1:1, d$upper[1:1], 1:2, d$upper[1:1], lty = 3)
segments(1:1, d$lower[1:2], 1:2, d$lower[1:2], lty = 3)
text(3, 1, paste("P-value", round(t.test(x, y)$p.value, digits = 3)))
```

Q6: How much do two 95% confidence intervals around individual means from independent groups overlap when the effect is only just statistically significant (*p* ≈ 0.05) at an alpha of 0.05?

A) When the 95% confidence interval around one mean does not contain the mean of the other group, the groups differ significantly from each other.

B) When the 95% confidence interval around one mean does not overlap with the 95% confidence interval of the mean of the other group, the groups differ
significantly from each other.

C) When the overlap between two confidence intervals is approximately half of one side of the confidence interval, the groups differ significantly from each other.

D) There is no relationship between the overlap of the 95% confidence intervals around two independent means, and the *p*-value for the difference between these groups.


Note that this visual overlap rule can only be used when the comparison is made between independent groups, not between dependent groups! The 95% confidence interval around effect sizes is therefore typically more easily interpretable in relation to the significance of a test.
